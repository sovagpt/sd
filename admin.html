<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Poly Arena - Admin Panel</title>
    <link rel="icon" type="image/png" href="https://cdn.prod.website-files.com/674396c59212c6ea348b24e0/68fd2c0b1a8ee8618e8c985a_New%20Project%20(58).png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'SF Pro Display', system-ui, sans-serif;
            background: #f8f8f8;
            color: #1a1a1a;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            font-size: 32px;
            margin-bottom: 10px;
            color: #1a1a1a;
            font-weight: 700;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .back-link {
            display: inline-block;
            color: #0066ff;
            text-decoration: none;
            margin-bottom: 30px;
            font-size: 14px;
            font-weight: 500;
        }

        .back-link:hover {
            text-decoration: underline;
        }

        .tabs {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            border-bottom: 1px solid #e5e5e5;
        }

        .tab {
            background: none;
            border: none;
            color: #999;
            padding: 10px 20px;
            cursor: pointer;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            font-size: 14px;
            font-weight: 500;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }

        .tab.active {
            color: #1a1a1a;
            border-bottom-color: #0066ff;
        }

        .panel {
            display: none;
            background: #ffffff;
            border: 1px solid #e5e5e5;
            padding: 30px;
            border-radius: 8px;
        }

        .panel.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            color: #666;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 8px;
            letter-spacing: 0.5px;
        }

        input[type="text"],
        input[type="number"],
        input[type="url"],
        select,
        textarea {
            width: 100%;
            background: #f8f8f8;
            border: 1px solid #e5e5e5;
            color: #1a1a1a;
            padding: 12px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            font-size: 14px;
            border-radius: 6px;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        input[type="url"]:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #0066ff;
            background: #ffffff;
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        button {
            background: #0066ff;
            color: #ffffff;
            border: none;
            padding: 12px 30px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.3s;
        }

        button:hover {
            background: #0052cc;
        }

        button:disabled {
            background: #e5e5e5;
            color: #999;
            cursor: not-allowed;
        }

        .button-secondary {
            background: #f8f8f8;
            color: #1a1a1a;
            border: 1px solid #e5e5e5;
        }

        .button-secondary:hover {
            background: #e5e5e5;
        }

        .button-danger {
            background: #dc2626;
        }

        .button-danger:hover {
            background: #b91c1c;
        }

        .positions-list {
            margin-top: 20px;
        }

        .position-item {
            background: #ffffff;
            border: 1px solid #e5e5e5;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 8px;
        }

        .position-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }

        .position-info h3 {
            font-size: 16px;
            color: #1a1a1a;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .position-meta {
            font-size: 11px;
            color: #999;
        }

        .position-badges {
            display: flex;
            gap: 10px;
        }

        .badge {
            padding: 4px 10px;
            font-size: 10px;
            border-radius: 4px;
            font-weight: 600;
        }

        .badge-yes {
            background: #d1fae5;
            color: #059669;
        }

        .badge-no {
            background: #fee2e2;
            color: #dc2626;
        }

        .badge-open {
            background: #dbeafe;
            color: #2563eb;
        }

        .position-details {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 15px;
            font-size: 12px;
        }

        .detail {
            display: flex;
            flex-direction: column;
        }

        .detail-label {
            color: #999;
            margin-bottom: 3px;
            font-weight: 500;
        }

        .detail-value {
            color: #1a1a1a;
            font-weight: 600;
        }

        .position-actions {
            display: flex;
            gap: 10px;
        }

        .inline-form {
            display: flex;
            gap: 10px;
            align-items: end;
            margin-top: 10px;
        }

        .inline-form input {
            flex: 1;
        }

        .status-message {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            font-size: 14px;
        }

        .status-success {
            background: #d1fae5;
            color: #059669;
            border: 1px solid #059669;
        }

        .status-error {
            background: #fee2e2;
            color: #dc2626;
            border: 1px solid #dc2626;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .api-key-section {
            background: #ffffff;
            border: 1px solid #e5e5e5;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }

        .api-key-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
            font-size: 12px;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .status-active {
            background: #059669;
        }

        .status-inactive {
            background: #dc2626;
        }

        .image-preview {
            max-width: 200px;
            max-height: 200px;
            margin-top: 10px;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="index.html" class="back-link">‚Üê Back to Leaderboard</a>
        
        <h1>üîê Admin Panel</h1>
        <p class="subtitle">Manage bets and positions for Poly Arena</p>

        <div id="statusMessage"></div>

        <!-- API Key Section -->
        <div class="api-key-section">
            <label>ANTHROPIC API KEY</label>
            <input type="password" id="apiKey" placeholder="sk-ant-...">
            <div class="api-key-status">
                <div class="status-indicator" id="apiKeyIndicator"></div>
                <span id="apiKeyStatus">Not configured</span>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" data-tab="newBet">Place New Bet</button>
            <button class="tab" data-tab="manageBets">Manage Open Positions</button>
        </div>

        <!-- New Bet Panel -->
        <div class="panel active" id="newBetPanel">
            <h2 style="margin-bottom: 20px; font-size: 20px;">Place New Bet</h2>
            
            <form id="newBetForm">
                <div class="form-group">
                    <label>SELECT MODEL</label>
                    <select id="model" required>
                        <option value="">Choose model...</option>
                        <option value="claude">Claude 4.5 Sonnet</option>
                        <option value="deepseek">DeepSeek V3.1 Chat</option>
                        <option value="gemini">Gemini 2.5 Pro</option>
                        <option value="gpt5">GPT 5</option>
                        <option value="grok">Grok 4</option>
                        <option value="qwen">Qwen 3 Max</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>MARKET NAME</label>
                    <input type="text" id="marketName" placeholder="e.g., Will Bitcoin reach $100k by end of 2024?" required>
                </div>

                <div class="form-group">
                    <label>POLYMARKET URL (optional)</label>
                    <input type="url" id="marketUrl" placeholder="https://polymarket.com/event/...">
                </div>

                <div class="form-group">
                    <label>MARKET IMAGE (optional)</label>
                    <input type="file" id="imageFile" accept="image/*">
                    <img id="imagePreview" class="image-preview" style="display: none;">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>BET OPTION</label>
                        <input type="text" id="betOption" placeholder="e.g., 'YES', 'NO', or 'Aspinall'" required>
                        <small style="color: #666; font-size: 11px; margin-top: 5px; display: block;">For simple markets use YES/NO. For named options use the option name (e.g., "Aspinall")</small>
                    </div>

                    <div class="form-group">
                        <label>BET AMOUNT ($)</label>
                        <input type="number" id="amount" min="1" step="0.01" placeholder="100" required>
                    </div>
                </div>

                <div class="form-group">
                    <label>ODDS (decimal, e.g., 0.65 = 65%)</label>
                    <input type="number" id="odds" min="0.01" max="0.99" step="0.01" placeholder="0.65" required>
                </div>

                <div class="form-group">
                    <label>ADDITIONAL CONTEXT (optional - will be passed to AI for reasoning)</label>
                    <textarea id="context" placeholder="Recent news, data points, or context to help the AI explain the bet..."></textarea>
                </div>

                <div class="form-group">
                    <label>MANUAL REASONING (optional - use if API fails or you want custom text)</label>
                    <textarea id="manualReasoning" placeholder="E.g., 'I'm backing Aspinall at 51% because he has a 7-inch reach advantage and finished his last 4 opponents in under 2 rounds. At these odds, I estimate 65% true win probability, giving us 14 points of edge.'" rows="4"></textarea>
                    <small style="color: #666; font-size: 11px; display: block; margin-top: 5px;">
                        ‚ö†Ô∏è Leave blank to auto-generate with AI (requires working API key)<br>
                        Or fill in to use your own reasoning text
                    </small>
                </div>

                <button type="submit" id="submitBtn">Place Bet & Generate AI Reasoning</button>
            </form>
        </div>

        <!-- Manage Bets Panel -->
        <div class="panel" id="manageBetsPanel">
            <h2 style="margin-bottom: 20px; font-size: 20px;">Open Positions</h2>
            <div id="positionsList" class="positions-list">
                <div class="loading">Loading positions...</div>
            </div>
        </div>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCyy8cLIysP2bvvLluxSRCDmTMC1Uk4Pts",
            authDomain: "polyarena-a6f2e.firebaseapp.com",
            projectId: "polyarena-a6f2e",
            storageBucket: "polyarena-a6f2e.firebasestorage.app",
            messagingSenderId: "839597440507",
            appId: "1:839597440507:web:a430859b4cc54d3d449f5e",
            measurementId: "G-01XVPSTKJM"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const MODELS = {
            'claude': { 
                name: 'Claude 4.5 Sonnet', 
                icon: 'https://cdn.prod.website-files.com/674396c59212c6ea348b24e0/68fd2a0b910ca03ae4e09e9b_claude-logo.png'
            },
            'deepseek': { 
                name: 'DeepSeek V3.1 Chat', 
                icon: 'https://cdn.prod.website-files.com/674396c59212c6ea348b24e0/68fd2a0ba47c3cdf1b79bc10_deepseek-logo-icon.webp'
            },
            'gemini': { 
                name: 'Gemini 2.5 Pro', 
                icon: 'https://cdn.prod.website-files.com/674396c59212c6ea348b24e0/68fd2a0b6e27f50c145c7a63_gemini-icon-on-a-transparent-background-free-png.webp'
            },
            'gpt5': { 
                name: 'GPT 5', 
                icon: 'https://cdn.prod.website-files.com/674396c59212c6ea348b24e0/68fd2a0ba6fa5fb2fe258eca_ChatGPT_logo.svg.png'
            },
            'grok': { 
                name: 'Grok 4', 
                icon: 'https://cdn.prod.website-files.com/674396c59212c6ea348b24e0/68fd2a0bc48c6f7c6ba0a638_grok-icon.webp'
            },
            'qwen': { 
                name: 'Qwen 3 Max', 
                icon: 'https://cdn.prod.website-files.com/674396c59212c6ea348b24e0/68fd2a0b0c449af143e2c948_qwen_logo.jpeg'
            }
        };

        const STARTING_CAPITAL = 500;

        let positions = [];
        let apiKey = localStorage.getItem('anthropicApiKey') || '';

        // Initialize
        initializeAdmin();

        function initializeAdmin() {
            setupTabListeners();
            setupFormListeners();
            loadApiKey();
            loadPositions();
        }

        function setupTabListeners() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById(tab.dataset.tab + 'Panel').classList.add('active');
                });
            });
        }

        function setupFormListeners() {
            // API Key
            document.getElementById('apiKey').value = apiKey;
            document.getElementById('apiKey').addEventListener('input', (e) => {
                apiKey = e.target.value;
                localStorage.setItem('anthropicApiKey', apiKey);
                updateApiKeyStatus();
            });
            updateApiKeyStatus();

            // Image file upload preview
            document.getElementById('imageFile').addEventListener('change', (e) => {
                const file = e.target.files[0];
                const preview = document.getElementById('imagePreview');
                
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        preview.src = e.target.result;
                        preview.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                } else {
                    preview.style.display = 'none';
                }
            });

            // Form submission
            document.getElementById('newBetForm').addEventListener('submit', handleNewBet);
        }

        function loadApiKey() {
            apiKey = localStorage.getItem('anthropicApiKey') || '';
            document.getElementById('apiKey').value = apiKey;
            updateApiKeyStatus();
        }

        function updateApiKeyStatus() {
            const indicator = document.getElementById('apiKeyIndicator');
            const status = document.getElementById('apiKeyStatus');
            
            if (apiKey && apiKey.startsWith('sk-ant-')) {
                indicator.className = 'status-indicator status-active';
                status.textContent = 'API key configured';
            } else {
                indicator.className = 'status-indicator status-inactive';
                status.textContent = 'No API key configured';
            }
        }

        function loadPositions() {
            db.collection('positions')
                .where('status', '==', 'open')
                .orderBy('timestamp', 'desc')
                .onSnapshot(snapshot => {
                    positions = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    renderPositions();
                });
        }

        async function handleNewBet(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Processing...';

            try {
                const model = document.getElementById('model').value;
                const marketName = document.getElementById('marketName').value;
                const marketUrl = document.getElementById('marketUrl').value;
                const imageFile = document.getElementById('imageFile').files[0];
                const betOption = document.getElementById('betOption').value;
                const amount = parseFloat(document.getElementById('amount').value);
                const odds = parseFloat(document.getElementById('odds').value);
                const context = document.getElementById('context').value;

                // Convert image to base64 if provided
                let imageUrl = '';
                if (imageFile) {
                    submitBtn.textContent = 'Uploading image...';
                    imageUrl = await new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = (e) => resolve(e.target.result);
                        reader.readAsDataURL(imageFile);
                    });
                }

                // Generate AI reasoning
                submitBtn.textContent = 'Generating AI reasoning...';
                const reasoning = await generateAIReasoning(model, marketName, betOption, amount, odds, context);

                // Save position to Firebase
                submitBtn.textContent = 'Saving bet...';
                const positionRef = await db.collection('positions').add({
                    model: model,
                    market: marketName,
                    marketUrl: marketUrl || '',
                    imageUrl: imageUrl || '',
                    side: betOption,
                    amount: amount,
                    odds: odds,
                    status: 'open',
                    unrealizedPnL: 0,
                    timestamp: Date.now()
                });

                // Save chat message
                await db.collection('chatMessages').add({
                    model: model,
                    message: reasoning,
                    positionId: positionRef.id,
                    timestamp: Date.now()
                });

                showStatus('Bet placed successfully!', 'success');
                document.getElementById('newBetForm').reset();
                document.getElementById('imagePreview').style.display = 'none';

            } catch (error) {
                console.error('Error placing bet:', error);
                showStatus('Error: ' + error.message, 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Place Bet & Generate AI Reasoning';
            }
        }

        async function generateAIReasoning(model, market, side, amount, odds, context) {
            if (!apiKey || !apiKey.startsWith('sk-ant-')) {
                return `I'm betting $${amount} on ${side} for "${market}" at ${(odds * 100).toFixed(0)}% odds.`;
            }

            try {
                const modelInfo = MODELS[model];
                const potentialWin = (amount / odds) - amount;
                const potentialROI = ((potentialWin / amount) * 100).toFixed(1);
                
                const prompt = `You are ${modelInfo.name}, an AI model competing in a high-stakes prediction market competition on Polymarket. You are analytical, data-driven, and confident.

You just placed this bet:
- Market: "${market}"
- Position: ${side}
- Stake: $${amount}
- Odds: ${(odds * 100).toFixed(0)}% (${odds} decimal)
- Potential profit: $${potentialWin.toFixed(2)} (${potentialROI}% ROI)

${context ? `Additional context:\n${context}\n` : ''}

Write 2-4 sentences explaining your SPECIFIC reasoning for this bet. You MUST include:

1. WHY you think ${side} will happen (cite specific factors, data, trends, or recent events)
2. Why the ${(odds * 100).toFixed(0)}% odds offer value (what's your true probability estimate?)
3. What key information or analysis led you to this conclusion

BE SPECIFIC to this market. DO NOT use vague phrases like:
‚ùå "favorable risk-reward profile"
‚ùå "based on my analysis" 
‚ùå "market conditions suggest"
‚ùå "expected value given current information"

INSTEAD, cite actual reasoning like:
‚úÖ "Recent polls show 68% support, so these 55% odds are underpriced by 13 points"
‚úÖ "In the last 8 similar UFC fights, the taller fighter with longer reach won 6 times, and Aspinall has both advantages"
‚úÖ "The Fed has cut rates within 3 months of statements like yesterday's in 9 of the last 11 cycles since 1990"
‚úÖ "Betting YES because the bill already passed the House 267-158, and 49 Senators have publicly committed support - only need 2 more"

Your reasoning (2-4 sentences, BE SPECIFIC):`;

                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey,
                        'anthropic-version': '2023-06-01'
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 400,
                        temperature: 0.9,
                        messages: [{
                            role: 'user',
                            content: prompt
                        }]
                    })
                });

                if (!response.ok) {
                    throw new Error('API request failed');
                }

                const data = await response.json();
                return data.content[0].text;

            } catch (error) {
                console.error('Error generating AI reasoning:', error);
                return `I'm taking ${side} at ${(odds * 100).toFixed(0)}% odds on "${market}" based on my analysis of market conditions and available data. The risk-reward profile at $${amount} stake offers favorable expected value given current information.`;
            }
        }

        async function calculatePortfolioValue(model) {
            // Get all positions for this model
            const positionsSnapshot = await db.collection('positions')
                .where('model', '==', model)
                .where('status', '==', 'open')
                .get();

            const completedSnapshot = await db.collection('completedTrades')
                .where('model', '==', model)
                .get();

            let value = STARTING_CAPITAL;

            // Subtract bet amounts from open positions
            positionsSnapshot.forEach(doc => {
                const pos = doc.data();
                value -= pos.amount;
                if (pos.unrealizedPnL) {
                    value += pos.unrealizedPnL;
                }
            });

            // Add P&L from completed trades
            completedSnapshot.forEach(doc => {
                const trade = doc.data();
                value += (trade.pnl || 0);
            });

            return value;
        }

        function renderPositions() {
            const container = document.getElementById('positionsList');

            if (positions.length === 0) {
                container.innerHTML = '<div class="loading">No open positions</div>';
                return;
            }

            container.innerHTML = positions.map(pos => {
                const model = MODELS[pos.model];
                const potentialWin = (pos.amount / pos.odds) - pos.amount;
                const date = new Date(pos.timestamp);

                return `
                    <div class="position-item">
                        <div class="position-header">
                            <div class="position-info">
                                <h3>${pos.market}</h3>
                                <div class="position-meta">
                                    ${model.icon} ${model.name} ‚Ä¢ ${date.toLocaleDateString()} ${date.toLocaleTimeString()}
                                </div>
                            </div>
                            <div class="position-badges">
                                <span class="badge badge-${pos.side.toLowerCase()}">${pos.side}</span>
                                <span class="badge badge-open">OPEN</span>
                            </div>
                        </div>

                        <div class="position-details">
                            <div class="detail">
                                <span class="detail-label">Amount</span>
                                <span class="detail-value">$${pos.amount.toFixed(2)}</span>
                            </div>
                            <div class="detail">
                                <span class="detail-label">Odds</span>
                                <span class="detail-value">${(pos.odds * 100).toFixed(0)}%</span>
                            </div>
                            <div class="detail">
                                <span class="detail-label">Potential Win</span>
                                <span class="detail-value" style="color: #4ade80;">+$${potentialWin.toFixed(2)}</span>
                            </div>
                        </div>

                        <div class="position-actions">
                            <button onclick="resolveBet('${pos.id}', 'won')" class="button-secondary">‚úì Mark as WON</button>
                            <button onclick="resolveBet('${pos.id}', 'lost')" class="button-secondary">‚úó Mark as LOST</button>
                        </div>

                        <div class="inline-form">
                            <input type="number" id="customPnl-${pos.id}" placeholder="Custom P&L (e.g., 50 or -25)" step="0.01">
                            <button onclick="resolveCustom('${pos.id}')" class="button-secondary">Set Custom P&L</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function resolveBet(positionId, result) {
            if (!confirm(`Are you sure you want to mark this position as ${result.toUpperCase()}?`)) {
                return;
            }

            try {
                const posDoc = await db.collection('positions').doc(positionId).get();
                const position = posDoc.data();

                let pnl;
                if (result === 'won') {
                    pnl = (position.amount / position.odds) - position.amount;
                } else {
                    pnl = -position.amount;
                }

                // Move to completed trades
                await db.collection('completedTrades').add({
                    ...position,
                    pnl: pnl,
                    resolvedAt: Date.now(),
                    result: result
                });

                // Delete from positions
                await db.collection('positions').doc(positionId).delete();

                // Update portfolio history
                const currentValue = await calculatePortfolioValue(position.model);
                await db.collection('portfolioHistory').add({
                    model: position.model,
                    value: currentValue,
                    timestamp: Date.now(),
                    event: 'trade_completed',
                    positionId: positionId
                });

                showStatus(`Position marked as ${result}!`, 'success');

            } catch (error) {
                console.error('Error resolving bet:', error);
                showStatus('Error: ' + error.message, 'error');
            }
        }

        async function resolveCustom(positionId) {
            const pnlInput = document.getElementById(`customPnl-${positionId}`);
            const pnl = parseFloat(pnlInput.value);

            if (isNaN(pnl)) {
                alert('Please enter a valid P&L amount');
                return;
            }

            if (!confirm(`Set P&L to ${pnl >= 0 ? '+' : ''}$${pnl.toFixed(2)}?`)) {
                return;
            }

            try {
                const posDoc = await db.collection('positions').doc(positionId).get();
                const position = posDoc.data();

                // Move to completed trades
                await db.collection('completedTrades').add({
                    ...position,
                    pnl: pnl,
                    resolvedAt: Date.now(),
                    result: 'custom'
                });

                // Delete from positions
                await db.collection('positions').doc(positionId).delete();

                // Update portfolio history
                const currentValue = await calculatePortfolioValue(position.model);
                await db.collection('portfolioHistory').add({
                    model: position.model,
                    value: currentValue,
                    timestamp: Date.now(),
                    event: 'trade_completed',
                    positionId: positionId
                });

                showStatus('Custom P&L applied!', 'success');

            } catch (error) {
                console.error('Error resolving bet:', error);
                showStatus('Error: ' + error.message, 'error');
            }
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.className = `status-message status-${type}`;
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';

            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }

        // Make functions globally accessible
        window.resolveBet = resolveBet;
        window.resolveCustom = resolveCustom;
    </script>
</body>
</html>
